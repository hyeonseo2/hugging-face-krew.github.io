name: ðŸ“ Author Registration Automation

on:
  issues:
    types: [opened]

jobs:
  process-author-registration:
    # author-registration ë¼ë²¨ì´ ìžˆëŠ” ì´ìŠˆë§Œ ì²˜ë¦¬
    if: contains(github.event.issue.labels.*.name, 'author-registration')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: ðŸ“‹ Extract Issue Information
        id: extract
        run: |
          # ì´ìŠˆ ìƒì„±ìž ì •ë³´
          echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          
          # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ë°ì´í„° ì¶”ì¶œì„ ìœ„í•œ ì¤€ë¹„
          echo "Extracting data from issue body..."

      - name: ðŸ” Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            
            // ê° í•„ë“œë¥¼ ì •ê·œì‹ìœ¼ë¡œ ì¶”ì¶œ
            function extractField(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }
            
            // ë‹¤ì¤‘ ì¤„ í•„ë“œ ì¶”ì¶œ (descriptionìš©)
            function extractMultilineField(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}\\s*\\n([\\s\\S]*?)(?=\\n### |$)`, 'i');
              const match = body.match(regex);
              if (!match) return '';
              
              let content = match[1].trim();
              
              // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° (```text ... ``` ë˜ëŠ” ``` ... ```)
              content = content.replace(/^```[\w]*\s*\n?/, '').replace(/\n?```\s*$/, '');
              
              // ë¶ˆí•„ìš”í•œ ê³µë°±ê³¼ ì¤„ë°”ê¿ˆ ì •ë¦¬
              content = content.trim();
              
              // ë¹ˆ ë¬¸ìžì—´ì´ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
              return content || '';
            }
            
            // ë“œë¡­ë‹¤ìš´ ì„ íƒê°’ ì¶”ì¶œ (íŠ¹ë³„ ì²˜ë¦¬)
            function extractDropdown(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }
            
            const data = {
              author_key: extractField(issueBody, 'ìž‘ì„±ìž ID \\(ì˜ë¬¸\\)'),
              name: extractField(issueBody, 'ì‹¤ëª…'),
              display_name: extractField(issueBody, 'í‘œì‹œ ì´ë¦„'),
              email: extractField(issueBody, 'ì´ë©”ì¼ ì£¼ì†Œ'),
              web: extractField(issueBody, 'ê°œì¸ ì›¹ì‚¬ì´íŠ¸ ë˜ëŠ” GitHub'),
              description: extractMultilineField(issueBody, 'ìžê¸°ì†Œê°œ'),
              avatar_option: extractDropdown(issueBody, 'í”„ë¡œí•„ ì´ë¯¸ì§€ ì˜µì…˜')
            };
            
            console.log('Extracted data:', data);
            
            // ë””ë²„ê¹…: description ì¶”ì¶œ ê³¼ì • ë¡œê·¸
            console.log('Debug - Raw description match:', issueBody.match(/### ìžê¸°ì†Œê°œ\s*\n([\s\S]*?)(?=\n### |$)/i));
            console.log('Debug - Description processing steps:');
            const rawDesc = issueBody.match(/### ìžê¸°ì†Œê°œ\s*\n([\s\S]*?)(?=\n### |$)/i);
            if (rawDesc) {
              console.log('  1. Raw match:', JSON.stringify(rawDesc[1]));
              let step = rawDesc[1].trim();
              console.log('  2. After trim:', JSON.stringify(step));
              step = step.replace(/^```[\w]*\s*\n?/, '').replace(/\n?```\s*$/, '');
              console.log('  3. After code block removal:', JSON.stringify(step));
              console.log('  4. Final result:', JSON.stringify(step.trim()));
            }
            
            // GitHub Actions í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
            for (const [key, value] of Object.entries(data)) {
              core.setOutput(key, value);
            }
            
            return data;

      - name: âœ… Validate Required Fields
        run: |
          # í•„ìˆ˜ í•„ë“œ ê²€ì¦
          if [ -z "${{ steps.parse.outputs.author_key }}" ]; then
            echo "âŒ Error: ìž‘ì„±ìž IDê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "${{ steps.parse.outputs.name }}" ]; then
            echo "âŒ Error: ì‹¤ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "${{ steps.parse.outputs.display_name }}" ]; then
            echo "âŒ Error: í‘œì‹œ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "${{ steps.parse.outputs.email }}" ]; then
            echo "âŒ Error: ì´ë©”ì¼ ì£¼ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  í•„ìˆ˜ í•„ë“œê°€ ìž…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ–¼ï¸ Process Avatar Image
        id: avatar
        run: |
          author_key="${{ steps.parse.outputs.author_key }}"
          avatar_option="${{ steps.parse.outputs.avatar_option }}"
          issue_author="${{ steps.extract.outputs.issue_author }}"
          
          echo "Processing avatar for: $author_key"
          echo "Avatar option: $avatar_option"
          echo "Issue author: $issue_author"
          
          if [[ "$avatar_option" == *"ë³¸ì¸ GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©"* ]]; then
            # ìžë™ìœ¼ë¡œ ì´ìŠˆ ìƒì„±ìžì˜ GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©
            github_username="$issue_author"
            echo "ðŸ¤– ìžë™ìœ¼ë¡œ ì´ìŠˆ ìƒì„±ìž í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©: $github_username"
            
            # GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            echo "ðŸ“¥ Downloading GitHub profile image..."
            mkdir -p assets/images/author
            
            if curl -L "https://github.com/$github_username.png" -o "assets/images/author/$author_key.png"; then
              echo "âœ… GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
              echo "avatar_path=assets/images/author/$author_key.png" >> $GITHUB_OUTPUT
            else
              echo "âŒ GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©"
              echo "avatar_path=assets/images/logo.png" >> $GITHUB_OUTPUT
            fi
            
          elif [[ "$avatar_option" == *"ì§ì ‘ ì—…ë¡œë“œ"* ]]; then
            echo "ðŸ“Ž ì§ì ‘ ì—…ë¡œë“œ ì˜µì…˜ ì„ íƒë¨"
            echo "ðŸ”„ ì´ìŠˆ ì²¨ë¶€íŒŒì¼ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì°¾ëŠ” ì¤‘..."
            
            # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ì²¨ë¶€ ì´ë¯¸ì§€ URL ì¶”ì¶œ
            issue_body='${{ github.event.issue.body }}'
            
            echo "ðŸ” Debug: ì´ìŠˆ ë³¸ë¬¸ ë‚´ìš© í™•ì¸ ì¤‘..."
            echo "Issue body preview:"
            echo "$issue_body" | head -20
            
            # ë‹¤ì–‘í•œ GitHub ì²¨ë¶€íŒŒì¼ URL íŒ¨í„´ ì‹œë„
            echo "ðŸ” ì²¨ë¶€íŒŒì¼ URL íŒ¨í„´ ê²€ìƒ‰ ì¤‘..."
            
            # íŒ¨í„´ 1: user-attachments/assets (ìµœì‹ ) - í™•ìž¥ìž ì—†ì´
            image_url=$(echo "$issue_body" | grep -o 'https://github\.com/user-attachments/assets/[a-f0-9-]*' | head -1)
            
            # íŒ¨í„´ 2: user-attachments/assets (í™•ìž¥ìž í¬í•¨)
            if [ -z "$image_url" ]; then
              image_url=$(echo "$issue_body" | grep -o 'https://github\.com/user-attachments/assets/[a-f0-9-]*\.[a-zA-Z]*' | head -1)
            fi
            
            # íŒ¨í„´ 3: user-attachments/files (ê¸°ì¡´)
            if [ -z "$image_url" ]; then
              image_url=$(echo "$issue_body" | grep -o 'https://github\.com/user-attachments/files/[0-9]*/[^)]*\.[a-zA-Z]*' | head -1)
            fi
            
            # íŒ¨í„´ 4: ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ ë§í¬
            if [ -z "$image_url" ]; then
              image_url=$(echo "$issue_body" | grep -o 'https://[^)]*\.\(png\|jpg\|jpeg\|gif\|webp\)' | head -1)
            fi
            
            echo "ðŸ” ê²€ìƒ‰ëœ ì´ë¯¸ì§€ URL: $image_url"
            
            if [ ! -z "$image_url" ]; then
              echo "ðŸŽ¯ ì²¨ë¶€ ì´ë¯¸ì§€ ë°œê²¬: $image_url"
              
              # íŒŒì¼ í™•ìž¥ìž ì¶”ì¶œ (í™•ìž¥ìžê°€ ì—†ìœ¼ë©´ pngë¡œ ê¸°ë³¸ê°’ ì„¤ì •)
              # URLì—ì„œ íŒŒì¼ í™•ìž¥ìžë§Œ ì¶”ì¶œ (2-4ê¸€ìž í™•ìž¥ìžë§Œ)
              file_ext=$(echo "$image_url" | grep -o '\.[a-zA-Z]\{2,4\}$' | sed 's/\.//')
              
              if [ -z "$file_ext" ]; then
                file_ext="png"
                echo "ðŸ”§ í™•ìž¥ìž ì—†ìŒ, ê¸°ë³¸ê°’ PNG ì‚¬ìš©"
              else
                echo "ðŸ”§ ì¶”ì¶œëœ í™•ìž¥ìž: $file_ext"
              fi
              
              echo "ðŸ“ ì‚¬ìš©í•  í™•ìž¥ìž: $file_ext"
              
              # ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
              mkdir -p assets/images/author
              
              if curl -L "$image_url" -o "assets/images/author/$author_key.$file_ext"; then
                echo "âœ… ì²¨ë¶€ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
                echo "avatar_path=assets/images/author/$author_key.$file_ext" >> $GITHUB_OUTPUT
              else
                echo "âŒ ì²¨ë¶€ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©"
                echo "avatar_path=assets/images/logo.png" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ ì²¨ë¶€ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©"
              echo "avatar_path=assets/images/logo.png" >> $GITHUB_OUTPUT
            fi
            
          else
            echo "ðŸ–¼ï¸ ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©"
            echo "avatar_path=assets/images/logo.png" >> $GITHUB_OUTPUT
          fi

      - name: âš™ï¸ Update _config.yml
        run: |
          author_key='${{ steps.parse.outputs.author_key }}'
          name='${{ steps.parse.outputs.name }}'
          display_name='${{ steps.parse.outputs.display_name }}'
          email='${{ steps.parse.outputs.email }}'
          web='${{ steps.parse.outputs.web }}'
          description='${{ steps.parse.outputs.description }}'
          avatar_path='${{ steps.avatar.outputs.avatar_path }}'
          
          echo "ðŸ“ Updating _config.yml with new author..."
          
          # authors ì„¹ì…˜ì˜ ë§ˆì§€ë§‰ ë¹ˆ ì¤„ì„ ì°¾ì•„ì„œ ìƒˆ ìž‘ì„±ìž ì¶”ê°€
          # authors ì„¹ì…˜ ë‹¤ìŒ ì²« ë²ˆì§¸ ë¹ˆ ì¤„ì„ ì°¾ê¸°
          authors_section_start=$(grep -n "^authors:" _config.yml | cut -d: -f1)
          
          if [ -z "$authors_section_start" ]; then
            echo "âŒ Error: authors ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ðŸ” authors ì„¹ì…˜ ì‹œìž‘: line $authors_section_start"
          
          # authors ì„¹ì…˜ ë‹¤ìŒ ì²« ë²ˆì§¸ ë¹ˆ ì¤„ ì°¾ê¸° (authors ë‹¤ìŒ ì„¹ì…˜ ì „ê¹Œì§€)
          empty_line=$(sed -n "${authors_section_start},\$p" _config.yml | grep -n "^$" | head -1 | cut -d: -f1)
          
          if [ -z "$empty_line" ]; then
            echo "âŒ Error: authors ì„¹ì…˜ì˜ ëì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ì‹¤ì œ ë¼ì¸ ë²ˆí˜¸ ê³„ì‚°
          insert_line=$((authors_section_start + empty_line - 1))
          echo "ðŸ” ì‚½ìž…í•  ìœ„ì¹˜: line $insert_line"
          
          # ìƒˆ ìž‘ì„±ìž ì •ë³´ ìƒì„± (ì˜¬ë°”ë¥¸ ë“¤ì—¬ì“°ê¸°ë¡œ)
          # ì§ì ‘ echo ë°©ì‹ìœ¼ë¡œ ìž„ì‹œ íŒŒì¼ ìƒì„± (ê°€ìž¥ ì•ˆì „í•œ ë°©ë²•)
          {
            echo "  $author_key:"
            echo "    name: $name"
            echo "    display_name: $display_name"
            echo "    avatar: '$avatar_path'"
            echo "    email: $email"
            echo "    web: $web"
            echo "    description: \"$description\""
          } > new_author.tmp
          
          # ìž„ì‹œ íŒŒì¼ ìƒì„±í•´ì„œ ì§€ì •ëœ ìœ„ì¹˜ì— ì‚½ìž…
          {
            head -n $((insert_line - 1)) _config.yml
            cat new_author.tmp
            tail -n +$insert_line _config.yml
          } > _config_temp.yml
          
          # ì›ë³¸ íŒŒì¼ êµì²´
          mv _config_temp.yml _config.yml
          
          # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f new_author.tmp
          
          echo "âœ… _config.yml ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "ðŸ“ ìƒˆ ìž‘ì„±ìžê°€ authors ì„¹ì…˜ ë‚´ë¶€ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ðŸ”§ Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "âœï¸: ìƒˆ ìž‘ì„±ìž ë“±ë¡ ${{ steps.parse.outputs.author_key }} (#${{ steps.extract.outputs.issue_number }})"
          title: "âœ¨ ìƒˆ ìž‘ì„±ìž ë“±ë¡: ${{ steps.parse.outputs.display_name }}"
          body: |
            ## ðŸ¤— ìƒˆ ë¸”ë¡œê·¸ ìž‘ì„±ìž ë“±ë¡
            
            **ì´ìŠˆ**: #${{ steps.extract.outputs.issue_number }}
            **ìš”ì²­ìž**: @${{ steps.extract.outputs.issue_author }}
            
            ### ðŸ‘¤ ìž‘ì„±ìž ì •ë³´
            - **ID**: `${{ steps.parse.outputs.author_key }}`
            - **ì´ë¦„**: ${{ steps.parse.outputs.name }}
            - **í‘œì‹œëª…**: ${{ steps.parse.outputs.display_name }}
            - **ì´ë©”ì¼**: ${{ steps.parse.outputs.email }}
            - **ì›¹ì‚¬ì´íŠ¸**: ${{ steps.parse.outputs.web }}
            - **í”„ë¡œí•„ ì´ë¯¸ì§€**: `${{ steps.avatar.outputs.avatar_path }}`
            
            ### ðŸ“ ìžê¸°ì†Œê°œ
            > ${{ steps.parse.outputs.description }}
            
            ---
            
            ì´ PRì´ ìŠ¹ì¸ë˜ë©´ @${{ steps.extract.outputs.issue_author }}ë‹˜ì´ ë¸”ë¡œê·¸ ìž‘ì„±ìžë¡œ ë“±ë¡ë©ë‹ˆë‹¤.
            
            ìžë™ ìƒì„±ëœ PRìž…ë‹ˆë‹¤. ðŸ¤–
          branch: author-registration/${{ steps.parse.outputs.author_key }}
          delete-branch: true

      - name: ðŸ’¬ Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.create_pr.outputs.pull-request-number }}';
            const authorKey = '${{ steps.parse.outputs.author_key }}';
            const displayName = '${{ steps.parse.outputs.display_name }}';
            
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ðŸŽ‰ ìžë™ ì²˜ë¦¬ ì™„ë£Œ!
            
            ì•ˆë…•í•˜ì„¸ìš” @${{ steps.extract.outputs.issue_author }}ë‹˜! 
            
            ìž‘ì„±ìž ë“±ë¡ ìš”ì²­ì´ ìžë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ðŸ“‹ ìƒì„±ëœ ë‚´ìš©
            - **Pull Request**: #${prNumber}
            - **ìž‘ì„±ìž ID**: \`${authorKey}\`
            - **í‘œì‹œëª…**: ${displayName}
            - **í”„ë¡œí•„ ì´ë¯¸ì§€**: ${{ steps.avatar.outputs.avatar_path }}
            
            ### ðŸ”„ ë‹¤ìŒ ë‹¨ê³„
            1. ê´€ë¦¬ìžê°€ PRì„ ê²€í† í•©ë‹ˆë‹¤
            2. PRì´ ìŠ¹ì¸ë˜ë©´ ìž‘ì„±ìžë¡œ ë“±ë¡ë©ë‹ˆë‹¤
            3. ë“±ë¡ ì™„ë£Œ í›„ ë¸”ë¡œê·¸ ê¸€ ìž‘ì„±ì„ ì‹œìž‘í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤!
            
            ê°ì‚¬í•©ë‹ˆë‹¤! ðŸ¤—`
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ
            
            ì£„ì†¡í•©ë‹ˆë‹¤. ìž‘ì„±ìž ë“±ë¡ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`
              });
            }

      - name: ðŸŽ¯ Workflow Summary
        run: |
          echo "## ðŸŽ‰ Author Registration Workflow ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "- **ìž‘ì„±ìž ID**: ${{ steps.parse.outputs.author_key }}" >> $GITHUB_STEP_SUMMARY
          echo "- **í‘œì‹œëª…**: ${{ steps.parse.outputs.display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR ë²ˆí˜¸**: #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **í”„ë¡œí•„ ì´ë¯¸ì§€**: ${{ steps.avatar.outputs.avatar_path }}" >> $GITHUB_STEP_SUMMARY
