name: ðŸ“ Author Registration Automation

on:
  issues:
    types: [opened]

jobs:
  process-author-registration:
    # author-registration ë¼ë²¨ì´ ìžˆëŠ” ì´ìŠˆë§Œ ì²˜ë¦¬
    if: contains(github.event.issue.labels.*.name, 'author-registration')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: ðŸ“‹ Extract Issue Information
        id: extract
        run: |
          # ì´ìŠˆ ìƒì„±ìž ì •ë³´
          echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          
          # ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ë°ì´í„° ì¶”ì¶œì„ ìœ„í•œ ì¤€ë¹„
          echo "Extracting data from issue body..."

      - name: ðŸ” Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            
            // ê° í•„ë“œë¥¼ ì •ê·œì‹ìœ¼ë¡œ ì¶”ì¶œ
            function extractField(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }
            
            // ë“œë¡­ë‹¤ìš´ ì„ íƒê°’ ì¶”ì¶œ (íŠ¹ë³„ ì²˜ë¦¬)
            function extractDropdown(body, fieldName) {
              const regex = new RegExp(`### ${fieldName}\\s*\\n\\s*([^\\n]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }
            
            const data = {
              author_key: extractField(issueBody, 'ìž‘ì„±ìž ID \\(ì˜ë¬¸\\)'),
              name: extractField(issueBody, 'ì‹¤ëª…'),
              display_name: extractField(issueBody, 'í‘œì‹œ ì´ë¦„'),
              email: extractField(issueBody, 'ì´ë©”ì¼ ì£¼ì†Œ'),
              web: extractField(issueBody, 'ê°œì¸ ì›¹ì‚¬ì´íŠ¸ ë˜ëŠ” GitHub'),
              description: extractField(issueBody, 'ìžê¸°ì†Œê°œ'),
              avatar_option: extractDropdown(issueBody, 'í”„ë¡œí•„ ì´ë¯¸ì§€ ì˜µì…˜')
            };
            
            console.log('Extracted data:', data);
            
            // GitHub Actions í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
            for (const [key, value] of Object.entries(data)) {
              core.setOutput(key, value);
            }
            
            return data;

      - name: âœ… Validate Required Fields
        run: |
          # í•„ìˆ˜ í•„ë“œ ê²€ì¦
          if [ -z "${{ steps.parse.outputs.author_key }}" ]; then
            echo "âŒ Error: ìž‘ì„±ìž IDê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "${{ steps.parse.outputs.name }}" ]; then
            echo "âŒ Error: ì‹¤ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "${{ steps.parse.outputs.display_name }}" ]; then
            echo "âŒ Error: í‘œì‹œ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          if [ -z "${{ steps.parse.outputs.email }}" ]; then
            echo "âŒ Error: ì´ë©”ì¼ ì£¼ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  í•„ìˆ˜ í•„ë“œê°€ ìž…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ–¼ï¸ Process Avatar Image
        id: avatar
        run: |
          author_key="${{ steps.parse.outputs.author_key }}"
          avatar_option="${{ steps.parse.outputs.avatar_option }}"
          issue_author="${{ steps.extract.outputs.issue_author }}"
          
          echo "Processing avatar for: $author_key"
          echo "Avatar option: $avatar_option"
          echo "Issue author: $issue_author"
          
          if [[ "$avatar_option" == *"ë³¸ì¸ GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©"* ]]; then
            # ìžë™ìœ¼ë¡œ ì´ìŠˆ ìƒì„±ìžì˜ GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©
            github_username="$issue_author"
            echo "ðŸ¤– ìžë™ìœ¼ë¡œ ì´ìŠˆ ìƒì„±ìž í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©: $github_username"
            
            # GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            echo "ðŸ“¥ Downloading GitHub profile image..."
            mkdir -p assets/images/author
            
            if curl -L "https://github.com/$github_username.png" -o "assets/images/author/$author_key.png"; then
              echo "âœ… GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
              echo "avatar_path=assets/images/author/$author_key.png" >> $GITHUB_OUTPUT
            else
              echo "âŒ GitHub í”„ë¡œí•„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©"
              echo "avatar_path=assets/images/logo.png" >> $GITHUB_OUTPUT
            fi
            
          elif [[ "$avatar_option" == *"ì§ì ‘ ì—…ë¡œë“œ"* ]]; then
            echo "ðŸ“Ž ì§ì ‘ ì—…ë¡œë“œ ì˜µì…˜ ì„ íƒë¨"
            echo "ðŸ”„ ì´ìŠˆ ì²¨ë¶€íŒŒì¼ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì°¾ëŠ” ì¤‘..."
            # TODO: ì´ìŠˆ ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ ë¡œì§ (í–¥í›„ êµ¬í˜„)
            echo "avatar_path=assets/images/logo.png" >> $GITHUB_OUTPUT
            
          else
            echo "ðŸ–¼ï¸ ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©"
            echo "avatar_path=assets/images/logo.png" >> $GITHUB_OUTPUT
          fi

      - name: âš™ï¸ Update _config.yml
        run: |
          author_key='${{ steps.parse.outputs.author_key }}'
          name='${{ steps.parse.outputs.name }}'
          display_name='${{ steps.parse.outputs.display_name }}'
          email='${{ steps.parse.outputs.email }}'
          web='${{ steps.parse.outputs.web }}'
          description='${{ steps.parse.outputs.description }}'
          avatar_path='${{ steps.avatar.outputs.avatar_path }}'
          
          echo "ðŸ“ Updating _config.yml with new author..."
          
          # _config.yml ë°±ì—…
          cp _config.yml _config.yml.bak
          
          # ìƒˆ ìž‘ì„±ìž ì •ë³´ë¥¼ _config.ymlì— ì¶”ê°€
          {
            echo "  $author_key:"
            echo "    name: $name"
            echo "    display_name: $display_name"
            echo "    avatar: '$avatar_path'"
            echo "    email: $email"
            echo "    web: $web"
            echo "    description: \"$description\""
          } >> _config.yml
          
          echo "âœ… _config.yml ì—…ë°ì´íŠ¸ ì™„ë£Œ"

      - name: ðŸ”§ Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Add new author ${{ steps.parse.outputs.author_key }}"
          title: "âœ¨ ìƒˆ ìž‘ì„±ìž ë“±ë¡: ${{ steps.parse.outputs.display_name }}"
          body: |
            ## ðŸ¤— ìƒˆ ë¸”ë¡œê·¸ ìž‘ì„±ìž ë“±ë¡
            
            **ì´ìŠˆ**: #${{ steps.extract.outputs.issue_number }}
            **ìš”ì²­ìž**: @${{ steps.extract.outputs.issue_author }}
            
            ### ðŸ‘¤ ìž‘ì„±ìž ì •ë³´
            - **ID**: `${{ steps.parse.outputs.author_key }}`
            - **ì´ë¦„**: ${{ steps.parse.outputs.name }}
            - **í‘œì‹œëª…**: ${{ steps.parse.outputs.display_name }}
            - **ì´ë©”ì¼**: ${{ steps.parse.outputs.email }}
            - **ì›¹ì‚¬ì´íŠ¸**: ${{ steps.parse.outputs.web }}
            - **í”„ë¡œí•„ ì´ë¯¸ì§€**: `${{ steps.avatar.outputs.avatar_path }}`
            
            ### ðŸ“ ìžê¸°ì†Œê°œ
            > ${{ steps.parse.outputs.description }}
            
            ---
            
            ì´ PRì´ ìŠ¹ì¸ë˜ë©´ @${{ steps.extract.outputs.issue_author }}ë‹˜ì´ ë¸”ë¡œê·¸ ìž‘ì„±ìžë¡œ ë“±ë¡ë©ë‹ˆë‹¤.
            
            ìžë™ ìƒì„±ëœ PRìž…ë‹ˆë‹¤. ðŸ¤–
          branch: author-registration/${{ steps.parse.outputs.author_key }}
          delete-branch: true

      - name: ðŸ’¬ Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.create_pr.outputs.pull-request-number }}';
            const authorKey = '${{ steps.parse.outputs.author_key }}';
            const displayName = '${{ steps.parse.outputs.display_name }}';
            
            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ðŸŽ‰ ìžë™ ì²˜ë¦¬ ì™„ë£Œ!
            
            ì•ˆë…•í•˜ì„¸ìš” @${{ steps.extract.outputs.issue_author }}ë‹˜! 
            
            ìž‘ì„±ìž ë“±ë¡ ìš”ì²­ì´ ìžë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ðŸ“‹ ìƒì„±ëœ ë‚´ìš©
            - **Pull Request**: #${prNumber}
            - **ìž‘ì„±ìž ID**: \`${authorKey}\`
            - **í‘œì‹œëª…**: ${displayName}
            - **í”„ë¡œí•„ ì´ë¯¸ì§€**: ${{ steps.avatar.outputs.avatar_path }}
            
            ### ðŸ”„ ë‹¤ìŒ ë‹¨ê³„
            1. ê´€ë¦¬ìžê°€ PRì„ ê²€í† í•©ë‹ˆë‹¤
            2. PRì´ ìŠ¹ì¸ë˜ë©´ ìž‘ì„±ìžë¡œ ë“±ë¡ë©ë‹ˆë‹¤
            3. ë“±ë¡ ì™„ë£Œ í›„ ë¸”ë¡œê·¸ ê¸€ ìž‘ì„±ì„ ì‹œìž‘í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤!
            
            ê°ì‚¬í•©ë‹ˆë‹¤! ðŸ¤—`
              });
              
              // ì´ìŠˆì— ë¼ë²¨ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['processed', 'pending-review']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ
            
            ì£„ì†¡í•©ë‹ˆë‹¤. ìž‘ì„±ìž ë“±ë¡ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`
              });
            }

      - name: ðŸŽ¯ Workflow Summary
        run: |
          echo "## ðŸŽ‰ Author Registration Workflow ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "- **ìž‘ì„±ìž ID**: ${{ steps.parse.outputs.author_key }}" >> $GITHUB_STEP_SUMMARY
          echo "- **í‘œì‹œëª…**: ${{ steps.parse.outputs.display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR ë²ˆí˜¸**: #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **í”„ë¡œí•„ ì´ë¯¸ì§€**: ${{ steps.avatar.outputs.avatar_path }}" >> $GITHUB_STEP_SUMMARY
